<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📢</text></svg>">
    <title>D365 Posts Bot - Teams App Installation</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <style type="text/css">
        .circle {
            width: 100px;
            height: 100px;
            margin-left: auto;
            margin-right: auto;
            border-radius: 50%;
            background-color: cornflowerblue;
            line-height: 100px;
            text-align: center;
            color: white;
            font-size: 50px;
        }

        .line {
            height: 100px;
            margin-left: 50%;
            border-left: 5px solid cornflowerblue;
            padding-left: 10px;
            padding-top: 10px;
        }
    </style>
</head>
<body>
    <main role="main" class="container">
        <div class="header">
            <h1 style="text-align: center">📢 D365 Posts Bot</h1>
            <p style="text-align: center; margin-top: 0; color: gray">by <a href="https://markcarrington.dev">Mark Carrington</a></p>
        </div>

        <div class="row" style="margin-top: 50px; border-top: solid 1px gray; padding-top: 50px">
            <div class="col-md-8">
                <h2>Teams App Installation</h2>

                <div id="loading">
                    <p style="text-align: center">
                        Loading, please wait...
                    </p>
                </div>
                <div id="notInstalled" style="display: none">
                    <p style="text-align: center">
                        The D365 Posts Bot Teams app is not installed in your organization, please <a href="teamsapp.html">install it first</a>
                    </p>
                </div>
                <div id="error" style="display: none">
                    <p>
                        ⚠ An error occurred:
                    </p>
                    <p id="errorDetails"></p>
                </div>
                <div id="ready" style="display: none">
                    <p>Select which users to install the app for from the list below:</p>

                    <p>
                        <strong>User</strong>

                    </p>
                    <div class="input-group mb-3">
                        <input type="text" id="searchTxt" class="form-control" placeholder="Search">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" id="searchBtn">🔎</button>
                        </div>
                    </div>
                    <table class="table table-striped table-fixed">
                        <thead>
                            <tr>
                                <th>
                                    <label class="checkbox">
                                        <input type="checkbox" id="selectAll" />
                                        Select all
                                    </label>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="usersTable" style="display: block; max-height: 500px; overflow-y: scroll"></tbody>
                    </table>

                    <p>
                        <input type="button" value="Install for Selected Users" id="install" class="btn btn-primary" />
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="circle">1</div>
                <div class="line"><a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=0436a86f-c175-43ad-bb20-9496b6f7d487&response_type=code&redirect_uri=https%3A%2F%2Fbot.markcarrington.dev%2F&response_mode=query&scope=https%3A%2F%2Fgraph.microsoft.com%2F.default">Grant access for the application</a></div>
                <div class="circle">2</div>
                <div class="line">Install the <a href="solution.html">managed solution</a></div>
                <div class="circle">3</div>
                <div class="line">Authorize the <a href="appuser.html">application user</a></div>
                <div class="circle">4</div>
                <div class="line">Install the <a href="teamsapp.html">Teams app</a></div>
                <div class="circle">fin</div>
            </div>
        </div>

        <script type="text/javascript" async>
            var appId;

            var getReq = function (url, token, successCallback, errorCallback) {
                var req = new XMLHttpRequest();
                req.open("GET", url);
                req.setRequestHeader("Authorization", "Bearer " + token);
                req.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE) {
                        if (this.status === 200) {
                            var obj = JSON.parse(this.response);
                            successCallback(obj);
                        }
                        else if (this.status === 429) {
                            setTimeout(function () {
                                getReq(url, token, successCallback, errorCallback);
                            }, 1000);
                        }
                        else {
                            var obj = null;
                            if (this.response)
                                obj = JSON.parse(this.response);
                            errorCallback(obj);
                        }
                    }
                };
                req.send();
            };

            var postReq = function (url, token, data, successCallback, errorCallback) {
                var req = new XMLHttpRequest();
                req.open("POST", url);
                req.setRequestHeader("Authorization", "Bearer " + token);
                req.setRequestHeader("Content-Type", "application/json");
                req.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE) {
                        if (this.status === 200 || this.status === 201 || this.status === 204) {
                            var obj = null;
                            if (this.response)
                                obj = JSON.parse(this.response);
                            successCallback(obj);
                        }
                        else if (this.status === 429) {
                            setTimeout(function () {
                                postReq(url, token, data, successCallback, errorCallback);
                            }, 1000);
                        }
                        else {
                            var obj = null;
                            if (this.response)
                                obj = JSON.parse(this.response);
                            errorCallback(obj);
                        }
                    }
                };
                req.send(JSON.stringify(data));
            };

            var getUsers = function (token) {
                var table = document.getElementById("usersTable");
                var loadUsersPage = function (url) {
                    getReq(
                        url,
                        token,
                        function (users) {
                            for (var i = 0; i < users.value.length; i++) {
                                var user = users.value[i];
                                var tr = document.createElement("tr");
                                table.appendChild(tr);

                                var td = document.createElement("td");
                                td.className = "displayName";
                                tr.appendChild(td);

                                var label = document.createElement("label");
                                label.title = user.userPrincipalName;
                                td.appendChild(label);

                                var chk = document.createElement("input");
                                chk.name = "userId";
                                chk.value = user.id;
                                chk.type = "checkbox";

                                label.appendChild(chk);
                                label.appendChild(document.createTextNode(" " + user.displayName));

                                var icon = document.createElement("span");
                                td.appendChild(icon);
                            }

                            if (users["@odata.nextLink"]) {
                                loadUsersPage(users["@odata.nextLink"]);
                            }
                            else {
                                document.getElementById("loading").style.display = "none";
                                document.getElementById("ready").style.display = "";
                            }
                        },
                        function (error) {
                            // Handle error
                            document.getElementById("loading").style.display = "none";
                            document.getElementById("error").style.display = "";

                            if (error)
                                document.getElementById("errorDetails").appendChild(document.createTextNode(JSON.stringify(error)));
                            else
                                document.getElementById("errorDetails").appendChild(document.createTextNode("Unknown error retrieving users"));
                        }
                    );
                };
                loadUsersPage("https://graph.microsoft.com/v1.0/users?$select=id,userPrincipalName,displayname");
            };

            getAppId = function (token) {
                getReq(
                    "https://graph.microsoft.com/v1.0/appCatalogs/teamsApps?$filter=externalId eq '4af72531-fb74-4ec1-860c-85ab616a6e67' and distributionMethod eq 'organization'",
                    token,
                    function (appDetails) {
                        if (appDetails.value.length === 1) {
                            appId = appDetails.value[0].id;
                            getUsers(token);
                        }
                        else {
                            // Handle error
                            document.getElementById("loading").style.display = "none";
                            document.getElementById("notInstalled").style.display = "";
                        }
                    },
                    function (error) {
                        // Handle error
                        document.getElementById("loading").style.display = "none";
                        document.getElementById("error").style.display = "";

                        if (error)
                            document.getElementById("errorDetails").appendChild(document.createTextNode(JSON.stringify(error)));
                        else
                            document.getElementById("errorDetails").appendChild(document.createTextNode("Unknown error retrieving app ID"));
                    }
                );
            };

            var checkAppInstalled = function (userId, token, callback) {
                getReq(
                    "https://graph.microsoft.com/beta/users/" + userId + "/teamwork/installedApps?$expand=teamsAppDefinition&filter=teamsAppDefinition/teamsAppId eq '" + appId + "'",
                    token,
                    function (installedApps) {
                        callback(installedApps.value.length > 0);
                    },
                    function (error) {
                        // Handle error
                        document.getElementById("users").style.display = "none";
                        document.getElementById("error").style.display = "";

                        if (error)
                            document.getElementById("errorDetails").appendChild(document.createTextNode(JSON.stringify(error)));
                        else
                            document.getElementById("errorDetails").appendChild(document.createTextNode("Unknown error checking if app is already installed for user"));
                    }
                );
            }

            var installAppIfMissing = function (userId, token, successCallback, errorCallback) {
                checkAppInstalled(userId, token, function (installed) {
                    if (installed) {
                        successCallback();
                        return;
                    }

                    postReq(
                        "https://graph.microsoft.com/beta/users/" + userId + "/teamwork/installedApps",
                        token,
                        { "teamsApp@odata.bind": "https://graph.microsoft.com/beta/appCatalogs/teamsApps/" + appId },
                        successCallback,
                        errorCallback
                    );
                });
            };

            var urlParams = new URLSearchParams(window.location.hash);
            var token = urlParams.get("#access_token");

            if (token) {
                getAppId(token);
            }
            else {
                // Handle error
                document.getElementById("loading").style.display = "none";
                document.getElementById("error").style.display = "";

                if (urlParams.get("error_description"))
                    document.getElementById("errorDetails").appendChild(document.createTextNode(urlParams.get("error_description")));
                else
                    document.getElementById("errorDetails").appendChild(document.createTextNode("Missing security token"));
            }

            document.getElementById("install").addEventListener("click", function () {
                var checkboxes = document.getElementsByName("userId");
                var i = -1;

                var installNext = function () {
                    i++;

                    while (i < checkboxes.length && !checkboxes[i].checked)
                        i++;

                    if (i === checkboxes.length)
                        return;

                    var userId = checkboxes[i].value;

                    var icon = checkboxes[i].parentElement.parentElement.lastChild;
                    icon.innerHTML = "⏳";

                    installAppIfMissing(
                        userId,
                        token,
                        function () {
                            icon.innerHTML = "✔";
                            installNext();
                        },
                        function (error) {
                            icon.innerHTML = "❌";
                            icon.title = JSON.stringify(error);
                            installNext();
                        }
                    );
                }

                installNext();
            });

            var searchUsers = function () {
                var rows = document.getElementsByTagName("tr");
                var searchText = document.getElementById("searchTxt").value;

                for (var i = 0; i < rows.length; i++) {
                    var tr = rows[i];

                    if (tr.textContent.substring(1, searchText.length + 1).toUpperCase() === searchText.toUpperCase()) {
                        tr.style.display = "";
                    }
                    else {
                        tr.style.display = "none";
                    }
                }
            };

            document.getElementById("searchBtn").addEventListener("click", searchUsers);
            document.getElementById("searchTxt").addEventListener("keydown", function (e) {
                if (e.keyCode === 13)
                    searchUsers();
            });

            document.getElementById("selectAll").addEventListener("click", function () {
                var checkboxes = document.querySelectorAll("input[type=checkbox]");

                for (var i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked = this.checked;
                }
            });
        </script>
    </main>
</body>
</html>